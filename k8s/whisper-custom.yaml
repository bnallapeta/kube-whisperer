apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  annotations:
    sidecar.istio.io/inject: "false"
    prometheus.io/scrape: "true"
    prometheus.io/path: "/metrics"
    prometheus.io/port: "8000"
  name: kube-whisperer
  namespace: default
spec:
  predictor:
    imagePullSecrets:
      - name: ${REGISTRY_SECRET_NAME}
    containers:
    - env:
      - name: WHISPER_MODEL
        value: base
      - name: COMPUTE_TYPE
        value: float16
      - name: CPU_THREADS
        value: "4"
      - name: NUM_WORKERS
        value: "2"
      - name: MAX_FILE_SIZE
        value: "26214400"
      - name: ENVIRONMENT
        value: "production"
      image: ${REGISTRY_IMAGE}
      livenessProbe:
        httpGet:
          path: /live
          port: http1
        initialDelaySeconds: 30
        periodSeconds: 30
        timeoutSeconds: 10
        failureThreshold: 3
        successThreshold: 1
      readinessProbe:
        httpGet:
          path: /ready
          port: http1
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
        successThreshold: 1
      startupProbe:
        httpGet:
          path: /health
          port: http1
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 30
        failureThreshold: 12
        successThreshold: 1
      name: kserve-container
      ports:
      - containerPort: 8000
        name: http1
        protocol: TCP
      resources:
        limits:
          cpu: "4"
          memory: 8Gi
          nvidia.com/gpu: "1"
        requests:
          cpu: "1"
          memory: 4Gi
          nvidia.com/gpu: "1"
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
      volumeMounts:
      - mountPath: /tmp
        name: temp
      - mountPath: /tmp/whisper_audio
        name: whisper-data
    volumes:
    - emptyDir:
        medium: Memory
        sizeLimit: 1Gi
      name: temp
    - emptyDir:
        medium: Memory
        sizeLimit: 2Gi
      name: whisper-data
